<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Chaves de Acesso</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Alinha ao topo */
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* Mais cantos arredondados */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* Permite cliques quando escondido */
        }
        .message-box.show {
            opacity: 1;
            pointer-events: auto;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="selection:bg-blue-200">
    <div class="container">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-4">üîë Gerador de Chaves de Acesso</h1>
        <p class="text-center text-gray-600 mb-6">Seu ID de Usu√°rio (para refer√™ncia): <span id="user-id" class="font-mono text-blue-700 break-all">Carregando...</span></p>

        <!-- Entrada da Dura√ß√£o da Validade da Chave com seletor de unidade -->
        <div class="flex flex-col gap-2">
            <label for="validity-value" class="text-lg font-semibold text-gray-700">Validade da Chave:</label>
            <div class="flex gap-2">
                <input type="number" id="validity-value" value="24" min="1" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-gray-50 text-gray-800 shadow-sm">
                <select id="validity-unit" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-gray-50 text-gray-800 shadow-sm">
                    <option value="minutes">Minutos</option>
                    <option value="hours" selected>Horas</option>
                    <option value="days">Dias</option>
                    <option value="months">Meses</option>
                    <option value="years">Anos</option>
                </select>
            </div>
        </div>

        <!-- Bot√£o de A√ß√£o -->
        <button id="generate-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 ease-in-out hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300">
            Gerar Nova Chave
        </button>

        <!-- Exibi√ß√£o da Chave Gerada -->
        <div class="flex flex-col gap-2 mt-4">
            <h2 class="text-2xl font-bold text-gray-800">Chave Gerada:</h2>
            <textarea id="generated-key-area" rows="4" readonly class="p-4 bg-gray-100 border border-gray-200 rounded-lg min-h-[100px] text-gray-700 leading-relaxed overflow-auto shadow-inner select-all" placeholder="Sua chave de acesso aparecer√° aqui."></textarea>
            <p id="expiration-info" class="text-sm text-gray-600">Validade: N/A</p>
        </div>

        <!-- Bot√£o de Copiar -->
        <button id="copy-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 ease-in-out hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300">
            Copiar Chave
        </button>
    </div>

    <!-- Caixa de Mensagem para alertas -->
    <div id="message-box" class="message-box"></div>

    <!-- Sobreposi√ß√£o de Carregamento -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Bibliotecas Firebase -->
    <script type="module">
        // Importa as fun√ß√µes necess√°rias dos SDKs Firebase (vers√£o 12.1.0)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // APP_ID FIXO - AGORA COM O VALOR DO SEU NOVO FIREBASE APP_ID
        const appId = "1:1055585794088:web:0c7eab96a4e696cd6f9d1d"; 

        const firebaseConfig = {
            apiKey: "AIzaSyCov5xP4aFRo3QPFCxCRQGN7X59dR9ZLF4",
            authDomain: "isiskd.firebaseapp.com",
            projectId: "isiskd",
            storageBucket: "isiskd.firebasestorage.app",
            messagingSenderId: "1055585794088",
            appId: "1:1055585794088:web:0c7eab96a4e696cd6f9d1d",
            measurementId: "G-5S8S16K6KF"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let isAuthReady = false;

        const userIdDisplay = document.getElementById('user-id');
        const validityValueInput = document.getElementById('validity-value');
        const validityUnitSelect = document.getElementById('validity-unit');
        const generatedKeyArea = document.getElementById('generated-key-area');
        const expirationInfo = document.getElementById('expiration-info');
        const generateButton = document.getElementById('generate-button');
        const copyButton = document.getElementById('copy-button');

        // Fun√ß√£o para exibir caixa de mensagem personalizada
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.className = 'message-box show'; // Reseta classes e mostra
            if (type === 'error') {
                messageBox.style.backgroundColor = '#dc2626'; // Vermelho
            } else if (type === 'success') {
                messageBox.style.backgroundColor = '#16a34a'; // Verde
            } else {
                messageBox.style.backgroundColor = '#333'; // Cinza escuro padr√£o
            }
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        // Fun√ß√£o para mostrar/esconder sobreposi√ß√£o de carregamento
        function toggleLoading(show) {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (show) {
                loadingOverlay.classList.add('show');
            } else {
                loadingOverlay.classList.remove('show');
            }
        }

        // Autentica com Firebase
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                try {
                    // Tenta fazer login com token personalizado se dispon√≠vel
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("KEY GEN APP: Firebase: Login com token personalizado.");
                    } else {
                        // Caso contr√°rio, faz login anonimamente
                        await signInAnonymously(auth);
                        console.log("KEY GEN APP: Firebase: Login an√¥nimo.");
                    }
                } catch (error) {
                    console.error("KEY GEN APP: Firebase Auth Error:", error);
                    showMessage(`Erro de autentica√ß√£o Firebase: ${error.message}`, 'error');
                }
            }
            userId = auth.currentUser?.uid || crypto.randomUUID(); // Usa auth.currentUser.uid se dispon√≠vel, caso contr√°rio um UUID aleat√≥rio
            userIdDisplay.textContent = userId;
            isAuthReady = true;
            console.log("KEY GEN APP: Firebase Auth Pronto. ID do Usu√°rio:", userId);
            console.log("KEY GEN APP: App ID em uso (FIXO):", appId); // Loga o appId fixo
        });

        // Listener de Eventos para gerar a chave
        generateButton.addEventListener('click', async () => {
            if (!isAuthReady) {
                showMessage("Autenticando com Firebase, por favor, aguarde...", 'info');
                return;
            }

            const validityValue = parseInt(validityValueInput.value, 10);
            const validityUnit = validityUnitSelect.value;

            if (isNaN(validityValue) || validityValue <= 0) {
                showMessage("Por favor, insira um valor num√©rico v√°lido para a validade.", 'error');
                return;
            }

            toggleLoading(true);
            generatedKeyArea.value = ''; // Limpa chave anterior
            expirationInfo.textContent = 'Validade: Gerando...'; // Atualiza informa√ß√£o de validade

            try {
                const newKey = crypto.randomUUID();
                const createdAt = Date.now();
                let expiresAt;

                // Calcula expiresAt com base na unidade selecionada
                switch (validityUnit) {
                    case 'minutes':
                        expiresAt = createdAt + (validityValue * 60 * 1000);
                        break;
                    case 'hours':
                        expiresAt = createdAt + (validityValue * 60 * 60 * 1000);
                        break;
                    case 'days':
                        expiresAt = createdAt + (validityValue * 24 * 60 * 60 * 1000);
                        break;
                    case 'months': // Aproximadamente 30 dias
                        expiresAt = createdAt + (validityValue * 30 * 24 * 60 * 60 * 1000);
                        break;
                    case 'years': // Aproximadamente 365 dias
                        expiresAt = createdAt + (validityValue * 365 * 24 * 60 * 60 * 1000);
                        break;
                    default:
                        expiresAt = createdAt + (24 * 60 * 60 * 1000); // Padr√£o: 24 horas
                        showMessage("Unidade de validade inv√°lida, usando padr√£o de 24 horas.", 'info');
                }
                console.log(`KEY GEN APP: Gerando chave. Valor: ${validityValue}, Unidade: ${validityUnit}, Expira em MS: ${expiresAt}`);

                // Armazena a chave no Firestore na cole√ß√£o P√öBLICA
                const keyDocRef = doc(db, `/artifacts/${appId}/public/data/accessKeys`, newKey);
                const keyDataToSave = {
                    key: newKey,
                    createdAt: createdAt,
                    expiresAt: expiresAt, // Isso ser√° salvo como um NUMBER no Firestore
                    validityValue: validityValue, // Salva o valor original
                    validityUnit: validityUnit,   // Salva a unidade original
                    status: 'active',
                    generatedByUserId: userId // Armazena o usu√°rio que a gerou para auditoria
                };
                await setDoc(keyDocRef, keyDataToSave);
                console.log("KEY GEN APP: Chave salva no Firestore. Dados:", keyDataToSave);


                generatedKeyArea.value = newKey; // Define a chave gerada aqui
                const expirationDate = new Date(expiresAt).toLocaleString('pt-BR');
                expirationInfo.textContent = `V√°lido at√©: ${expirationDate}`;
                showMessage("Chave gerada e salva com sucesso!", 'success');
                console.log("KEY GEN APP: Chave gerada e exibida:", newKey, "Expira:", new Date(expiresAt));

            } catch (error) {
                console.error("KEY GEN APP: Erro ao gerar ou salvar chave:", error);
                generatedKeyArea.value = "Erro ao gerar chave.";
                expirationInfo.textContent = 'Validade: Erro';
                showMessage(`Erro ao gerar ou salvar chave: ${error.message}`, 'error');
            } finally {
                toggleLoading(false);
            }
        });

        // Listener de Eventos para copiar a chave para a √°rea de transfer√™ncia
        copyButton.addEventListener('click', () => {
            const keyToCopy = generatedKeyArea.value;
            if (keyToCopy && keyToCopy !== "Erro ao gerar chave." && keyToCopy !== "Sua chave de acesso aparecer√° aqui.") { // Evita copiar placeholder/erro
                // Usa document.execCommand para opera√ß√µes de √°rea de transfer√™ncia em ambientes iframe
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = keyToCopy;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                try {
                    document.execCommand('copy');
                    showMessage("Chave copiada para a √°rea de transfer√™ncia!", 'success');
                } catch (err) {
                    console.error('KEY GEN APP: Falha ao copiar texto: ', err);
                    showMessage("Erro ao copiar a chave.", 'error');
                } finally {
                    document.body.removeChild(tempTextArea);
                }
            } else {
                showMessage("N√£o h√° chave v√°lida para copiar.", 'info');
            }
        });
    </script>
</body>
</html>
