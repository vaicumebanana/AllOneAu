<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador e Gerenciador de Chaves de Acesso</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Alinha ao topo */
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
            overflow-y: auto; /* Permite rolagem se o conte√∫do for grande */
        }
        .container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* Mais cantos arredondados */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            max-width: 800px; /* Largura m√°xima aumentada para acomodar o gerenciamento */
            width: 100%;
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* Permite cliques quando escondido */
        }
        .message-box.show {
            opacity: 1;
            pointer-events: auto;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .key-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            word-break: break-all; /* Garante que a chave longa quebre a linha */
        }
        .key-info {
            flex-grow: 1;
        }
        .key-actions {
            margin-left: 1rem;
            display: flex;
            flex-wrap: wrap; /* Permite que os bot√µes quebrem para a pr√≥xima linha em telas pequenas */
            gap: 0.5rem;
            justify-content: flex-end; /* Alinha os bot√µes √† direita quando quebrarem */
        }

        /* Estilos para a modal de confirma√ß√£o */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1002; /* Acima de tudo */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
    </style>
</head>
<body class="selection:bg-blue-200">
    <div class="container">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-4">üîë Gerador e Gerenciador de Chaves</h1>
        <p class="text-center text-gray-600 mb-6">Seu ID de Usu√°rio (para refer√™ncia): <span id="user-id" class="font-mono text-blue-700 break-all">Carregando...</span></p>

        <!-- Se√ß√£o de Gera√ß√£o de Chaves -->
        <div class="p-6 border border-gray-200 rounded-lg shadow-sm bg-gray-50">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Gerar Nova Chave</h2>
            
            <!-- Entrada do Nome da Pessoa -->
            <div class="flex flex-col gap-2 mb-4">
                <label for="person-name-input" class="text-lg font-semibold text-gray-700">Nome da Pessoa:</label>
                <input type="text" id="person-name-input" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-800 shadow-sm" placeholder="Ex: Jo√£o Silva ou Equipe Alpha">
            </div>

            <!-- Entrada da Dura√ß√£o da Validade da Chave com seletor de unidade -->
            <div class="flex flex-col gap-2 mb-4">
                <label for="validity-value" class="text-lg font-semibold text-gray-700">Validade da Chave:</label>
                <div class="flex gap-2">
                    <input type="number" id="validity-value" value="24" min="1" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-800 shadow-sm">
                    <select id="validity-unit" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-800 shadow-sm">
                        <option value="minutes">Minutos</option>
                        <option value="hours" selected>Horas</option>
                        <option value="days">Dias</option>
                        <option value="months">Meses</option>
                        <option value="years">Anos</option>
                    </select>
                </div>
            </div>

            <!-- Bot√£o de Gerar Chave -->
            <button id="generate-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 ease-in-out hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300 w-full mb-4">
                Gerar Nova Chave
            </button>

            <!-- Exibi√ß√£o da Chave Gerada -->
            <div class="flex flex-col gap-2">
                <h3 class="text-xl font-bold text-gray-800">Chave Gerada:</h3>
                <textarea id="generated-key-area" rows="3" readonly class="p-4 bg-gray-100 border border-gray-200 rounded-lg min-h-[80px] text-gray-700 leading-relaxed overflow-auto shadow-inner select-all" placeholder="Sua chave de acesso aparecer√° aqui."></textarea>
                <p id="expiration-info" class="text-sm text-gray-600">Validade: N/A</p>
            </div>

            <!-- Bot√£o de Copiar -->
            <button id="copy-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 ease-in-out hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300 w-full">
                Copiar Chave
            </button>
        </div>

        <!-- Se√ß√£o de Gerenciamento de Chaves -->
        <div class="p-6 border border-gray-200 rounded-lg shadow-sm bg-gray-50 mt-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Gerenciar Chaves Existentes</h2>
                <button id="refresh-keys-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Atualizar
                </button>
            </div>
            
            <div id="keys-list" class="flex flex-col gap-3">
                <p class="text-gray-500 text-center" id="loading-keys-message">Carregando chaves...</p>
                <!-- As chaves ser√£o listadas aqui -->
            </div>
            <p id="no-keys-message" class="text-gray-500 text-center mt-4 hidden">Nenhuma chave gerada ainda.</p>
        </div>
    </div>

    <!-- Caixa de Mensagem para alertas -->
    <div id="message-box" class="message-box"></div>

    <!-- Sobreposi√ß√£o de Carregamento -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Modal de Confirma√ß√£o Personalizada -->
    <div id="confirmation-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Confirmar Exclus√£o</h3>
            <p class="text-gray-700 mb-6">Tem certeza que deseja **EXCLUIR PERMANENTEMENTE** esta chave?</p>
            <p class="text-red-600 font-semibold mb-8">Esta a√ß√£o √© irrevers√≠vel.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-delete-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition-colors duration-200">
                    Confirmar Exclus√£o
                </button>
                <button id="cancel-delete-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-5 rounded-lg shadow-md transition-colors duration-200">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Bibliotecas Firebase -->
    <script type="module">
        // Importa as fun√ß√µes necess√°rias dos SDKs Firebase (vers√£o 12.1.0)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, getDocs, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // APP_ID FIXO - AGORA COM O VALOR DO SEU NOVO FIREBASE APP_ID
        const appId = "1:1055585794088:web:0c7eab96a4e696cd6f9d1d"; 

        const firebaseConfig = {
            apiKey: "AIzaSyCov5xP4aFRo3QPFCxCRQGN7X59dR9ZLF4",
            authDomain: "isiskd.firebaseapp.com",
            projectId: "isiskd",
            storageBucket: "isiskd.firebasestorage.app",
            messagingSenderId: "1055585794088",
            appId: "1:1055585794088:web:0c7eab96a4e696cd6f9d1d",
            measurementId: "G-5S8S16K6KF"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let isAuthReady = false;
        let keyToDeleteId = null; // Vari√°vel para armazenar o ID da chave a ser exclu√≠da temporariamente

        // Elementos de Gera√ß√£o de Chaves
        const userIdDisplay = document.getElementById('user-id');
        const personNameInput = document.getElementById('person-name-input');
        const validityValueInput = document.getElementById('validity-value');
        const validityUnitSelect = document.getElementById('validity-unit');
        const generatedKeyArea = document.getElementById('generated-key-area');
        const expirationInfo = document.getElementById('expiration-info');
        const generateButton = document.getElementById('generate-button');
        const copyButton = document.getElementById('copy-button');

        // Elementos de Gerenciamento de Chaves
        const keysList = document.getElementById('keys-list');
        const refreshKeysButton = document.getElementById('refresh-keys-button');
        const loadingKeysMessage = document.getElementById('loading-keys-message');
        const noKeysMessage = document.getElementById('no-keys-message');

        // Elementos da Modal de Confirma√ß√£o
        const confirmationModalOverlay = document.getElementById('confirmation-modal-overlay');
        const confirmDeleteButton = document.getElementById('confirm-delete-button');
        const cancelDeleteButton = document.getElementById('cancel-delete-button');


        // Fun√ß√µes de Utilidade
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.className = 'message-box show';
            if (type === 'error') {
                messageBox.style.backgroundColor = '#dc2626';
            } else if (type === 'success') {
                messageBox.style.backgroundColor = '#16a34a';
            } else {
                messageBox.style.backgroundColor = '#333';
            }
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        function toggleLoading(show) {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (show) {
                loadingOverlay.classList.add('show');
            } else {
                loadingOverlay.classList.remove('show');
            }
        }

        // Fun√ß√£o para mostrar a modal de confirma√ß√£o
        function showConfirmationModal(keyId) {
            keyToDeleteId = keyId; // Armazena o ID da chave para uso posterior
            confirmationModalOverlay.classList.add('show');
        }

        // Fun√ß√£o para esconder a modal de confirma√ß√£o
        function hideConfirmationModal() {
            keyToDeleteId = null; // Limpa o ID da chave
            confirmationModalOverlay.classList.remove('show');
        }

        // --- Fun√ß√µes de Gerenciamento de Chaves ---

        // Fun√ß√£o para carregar e exibir todas as chaves
        async function loadAccessKeys() {
            if (!userId) {
                console.warn("KEY GEN APP: N√£o √© poss√≠vel carregar chaves: userId n√£o definido.");
                return;
            }

            keysList.innerHTML = ''; // Limpa a lista
            loadingKeysMessage.classList.remove('hidden'); // Mostra mensagem de carregamento
            noKeysMessage.classList.add('hidden'); // Esconde mensagem de "nenhuma chave"
            toggleLoading(true);

            try {
                const keysCollectionRef = collection(db, `/artifacts/${appId}/public/data/accessKeys`);
                const q = query(keysCollectionRef);
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    noKeysMessage.classList.remove('hidden'); // Mostra mensagem de "nenhuma chave"
                    loadingKeysMessage.classList.add('hidden'); // Esconde carregamento
                } else {
                    querySnapshot.forEach((docSnap) => {
                        const keyData = docSnap.data();
                        const keyId = docSnap.id;
                        renderKeyItem(keyId, keyData);
                    });
                    loadingKeysMessage.classList.add('hidden'); // Esconde carregamento
                }
            } catch (error) {
                console.error("KEY GEN APP: Erro ao carregar chaves:", error);
                showMessage("Erro ao carregar chaves: " + error.message, 'error');
                loadingKeysMessage.classList.add('hidden'); // Esconde carregamento
                noKeysMessage.classList.remove('hidden'); // Mostra mensagem de erro
            } finally {
                toggleLoading(false);
            }
        }

        // Fun√ß√£o para renderizar um item de chave na lista
        function renderKeyItem(keyId, keyData) {
            const keyItemDiv = document.createElement('div');
            keyItemDiv.classList.add('key-list-item');
            keyItemDiv.dataset.keyId = keyId; // Armazena o ID da chave no elemento

            const statusClass = keyData.status === 'active' ? 'text-green-600' : 'text-red-600';
            const statusText = keyData.status === 'active' ? 'Ativa' : 'Inativa';

            let expiresDate = 'N/A';
            if (keyData.expiresAt) {
                if (typeof keyData.expiresAt.toDate === 'function') { // Firestore Timestamp
                    expiresDate = keyData.expiresAt.toDate().toLocaleString('pt-BR');
                } else if (typeof keyData.expiresAt === 'number') { // Milliseconds
                    expiresDate = new Date(keyData.expiresAt).toLocaleString('pt-BR');
                }
            }
            
            const lockedInfo = keyData.lockedToDeviceId ? ` (Bloqueada: ${keyData.lockedToDeviceId.substring(0, 8)}...)` : '';

            keyItemDiv.innerHTML = `
                <div class="key-info">
                    <p class="font-bold text-gray-800">${keyData.personName || 'N/A'}</p>
                    <p class="text-sm text-gray-700 break-all">Chave: ${keyId}</p>
                    <p class="text-xs text-gray-500">Validade: ${expiresDate}</p>
                    <p class="text-xs font-semibold ${statusClass}">Status: ${statusText}${lockedInfo}</p>
                </div>
                <div class="key-actions">
                    <button class="deactivate-key-button bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-md shadow-sm text-sm transition-colors duration-200" data-key-id="${keyId}" ${keyData.status === 'inactive' ? 'disabled' : ''}>
                        Desativar
                    </button>
                    <button class="reactivate-key-button bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-md shadow-sm text-sm transition-colors duration-200" data-key-id="${keyId}" ${keyData.status === 'active' ? 'disabled' : ''}>
                        Reativar
                    </button>
                    <button class="delete-key-button bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-md shadow-sm text-sm transition-colors duration-200" data-key-id="${keyId}">
                        Excluir
                    </button>
                </div>
            `;
            keysList.appendChild(keyItemDiv);
        }

        // Fun√ß√£o para desativar uma chave
        async function deactivateKey(keyId) {
            toggleLoading(true);
            try {
                const keyDocRef = doc(db, `/artifacts/${appId}/public/data/accessKeys`, keyId);
                await updateDoc(keyDocRef, { status: 'inactive' });
                showMessage(`Chave "${keyId.substring(0, 8)}..." desativada com sucesso!`, 'success');
                console.log(`KEY GEN APP: Chave ${keyId} desativada.`);
                loadAccessKeys(); // Recarrega a lista para refletir a mudan√ßa
            } catch (error) {
                console.error("KEY GEN APP: Erro ao desativar chave:", error);
                showMessage(`Erro ao desativar chave: ${error.message}`, 'error');
            } finally {
                toggleLoading(false);
            }
        }

        // Fun√ß√£o para reativar uma chave
        async function reactivateKey(keyId) {
            toggleLoading(true);
            try {
                const keyDocRef = doc(db, `/artifacts/${appId}/public/data/accessKeys`, keyId);
                // Ao reativar, definimos o status como 'active' e removemos o bloqueio de dispositivo.
                await updateDoc(keyDocRef, { status: 'active', lockedToDeviceId: null });
                showMessage(`Chave "${keyId.substring(0, 8)}..." reativada com sucesso!`, 'success');
                console.log(`KEY GEN APP: Chave ${keyId} reativada.`);
                loadAccessKeys(); // Recarrega a lista para refletir a mudan√ßa
            } catch (error) {
                console.error("KEY GEN APP: Erro ao reativar chave:", error);
                showMessage(`Erro ao reativar chave: ${error.message}`, 'error');
            } finally {
                toggleLoading(false);
            }
        }

        // Fun√ß√£o para excluir permanentemente uma chave (chamada ap√≥s a confirma√ß√£o da modal)
        async function deleteKeyConfirmed(confirmedKeyId) { // Agora recebe o ID como argumento
            if (!confirmedKeyId) {
                showMessage("Nenhuma chave selecionada para exclus√£o.", 'error');
                return;
            }

            toggleLoading(true);

            try {
                // Adiciona verifica√ß√µes para garantir que db e appId n√£o s√£o nulos
                if (!db) {
                    console.error("KEY GEN APP: Inst√¢ncia do Firestore DB √© nula ao tentar exclus√£o!");
                    showMessage("Erro interno: O banco de dados n√£o est√° pronto para exclus√£o.", 'error');
                    return; 
                }
                if (!appId) {
                    console.error("KEY GEN APP: ID do aplicativo √© nulo ao tentar exclus√£o!");
                    showMessage("Erro interno: ID do aplicativo n√£o definido.", 'error');
                    return;
                }

                console.log("KEY GEN APP: Tentando excluir chave com ID:", confirmedKeyId);
                // Constr√≥i o caminho completo do documento explicitamente
                const fullDocPath = `artifacts/${appId}/public/data/accessKeys/${confirmedKeyId}`;
                console.log("KEY GEN APP: Caminho completo do documento para exclus√£o:", fullDocPath);

                const keyDocRef = doc(db, fullDocPath); // Usa o caminho completo aqui
                console.log("KEY GEN APP: Refer√™ncia do documento constru√≠da para exclus√£o.");

                await deleteDoc(keyDocRef); // Executa a exclus√£o
                showMessage(`Chave "${confirmedKeyId.substring(0, 8)}..." exclu√≠da permanentemente!`, 'success');
                console.log(`KEY GEN APP: Chave ${confirmedKeyId} exclu√≠da permanentemente.`);
                loadAccessKeys(); // Recarrega a lista para a chave desaparecer
            } catch (error) {
                console.error("KEY GEN APP: Erro ao excluir chave:", error);
                showMessage(`Erro ao excluir chave: ${error.message || error}`, 'error');
            } finally {
                toggleLoading(false);
                hideConfirmationModal(); // Esconde a modal aqui, ap√≥s o processo
            }
        }

        // --- Event Listeners e Inicializa√ß√£o ---

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("KEY GEN APP: Firebase: Login com token personalizado.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("KEY GEN APP: Firebase: Login an√¥nimo.");
                    }
                } catch (error) {
                    console.error("KEY GEN APP: Firebase Auth Error:", error);
                    showMessage(`Erro de autentica√ß√£o Firebase: ${error.message}`, 'error');
                }
            }
            userId = auth.currentUser?.uid || crypto.randomUUID();
            userIdDisplay.textContent = userId;
            isAuthReady = true;
            console.log("KEY GEN APP: Firebase Auth Pronto. ID do Usu√°rio:", userId);
            console.log("KEY GEN APP: App ID em uso (FIXO):", appId);
            
            if (isAuthReady) {
                loadAccessKeys(); // Carrega as chaves ao iniciar
            }
        });

        generateButton.addEventListener('click', async () => {
            if (!isAuthReady) {
                showMessage("Autenticando com Firebase, por favor, aguarde...", 'info');
                return;
            }

            const personName = personNameInput.value.trim();
            const validityValue = parseInt(validityValueInput.value, 10);
            const validityUnit = validityUnitSelect.value;

            if (!personName) {
                showMessage("Por favor, insira o nome da pessoa.", 'error');
                return;
            }

            if (isNaN(validityValue) || validityValue <= 0) {
                showMessage("Por favor, insira um valor num√©rico v√°lido para a validade.", 'error');
                return;
            }

            toggleLoading(true);
            generatedKeyArea.value = '';
            expirationInfo.textContent = 'Validade: Gerando...';

            try {
                const newKey = crypto.randomUUID();
                const createdAt = Date.now();
                let expiresAt;

                switch (validityUnit) {
                    case 'minutes': expiresAt = createdAt + (validityValue * 60 * 1000); break;
                    case 'hours': expiresAt = createdAt + (validityValue * 60 * 60 * 1000); break;
                    case 'days': expiresAt = createdAt + (validityValue * 24 * 60 * 60 * 1000); break;
                    case 'months': expiresAt = createdAt + (validityValue * 30 * 24 * 60 * 60 * 1000); break; // Aproximado
                    case 'years': expiresAt = createdAt + (validityValue * 365 * 24 * 60 * 60 * 1000); break; // Aproximado
                    default: expiresAt = createdAt + (24 * 60 * 60 * 1000); showMessage("Unidade de validade inv√°lida, usando padr√£o de 24 horas.", 'info');
                }

                const keyDataToSave = {
                    key: newKey,
                    personName: personName, // Adicionado o nome da pessoa
                    createdAt: createdAt,
                    expiresAt: expiresAt,
                    validityValue: validityValue,
                    validityUnit: validityUnit,
                    status: 'active',
                    generatedByUserId: userId,
                    lockedToDeviceId: null
                };
                const keyDocRef = doc(db, `/artifacts/${appId}/public/data/accessKeys`, newKey);
                await setDoc(keyDocRef, keyDataToSave);
                console.log("KEY GEN APP: Chave salva no Firestore. Dados:", keyDataToSave);

                generatedKeyArea.value = newKey;
                const expirationDate = new Date(expiresAt).toLocaleString('pt-BR');
                expirationInfo.textContent = `V√°lido at√©: ${expirationDate}`;
                showMessage("Chave gerada e salva com sucesso!", 'success');
                
                loadAccessKeys(); // Recarrega a lista para mostrar a nova chave

            } catch (error) {
                console.error("KEY GEN APP: Erro ao gerar ou salvar chave:", error);
                generatedKeyArea.value = "Erro ao gerar chave.";
                expirationInfo.textContent = 'Validade: Erro';
                showMessage(`Erro ao gerar ou salvar chave: ${error.message}`, 'error');
            } finally {
                toggleLoading(false);
            }
        });

        copyButton.addEventListener('click', () => {
            const keyToCopy = generatedKeyArea.value;
            if (keyToCopy && keyToCopy !== "Erro ao gerar chave." && keyToCopy !== "Sua chave de acesso aparecer√° aqui.") {
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = keyToCopy;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                try {
                    document.execCommand('copy');
                    showMessage("Chave copiada para a √°rea de transfer√™ncia!", 'success');
                } catch (err) {
                    console.error('KEY GEN APP: Falha ao copiar texto: ', err);
                    showMessage("Erro ao copiar a chave.", 'error');
                } finally {
                    document.body.removeChild(tempTextArea);
                }
            } else {
                showMessage("N√£o h√° chave v√°lida para copiar.", 'info');
            }
        });

        // Listener para o bot√£o de atualiza√ß√£o das chaves
        refreshKeysButton.addEventListener('click', loadAccessKeys);

        // Listener de eventos para os bot√µes de desativar, reativar e excluir (delega√ß√£o)
        keysList.addEventListener('click', (event) => {
            if (event.target.classList.contains('deactivate-key-button')) {
                const keyId = event.target.dataset.keyId;
                if (keyId) {
                    deactivateKey(keyId);
                }
            } else if (event.target.classList.contains('reactivate-key-button')) {
                const keyId = event.target.dataset.keyId;
                if (keyId) {
                    reactivateKey(keyId);
                }
            } else if (event.target.classList.contains('delete-key-button')) {
                const keyId = event.target.dataset.keyId;
                if (keyId) {
                    showConfirmationModal(keyId); // Mostra a modal de confirma√ß√£o
                }
            }
        });

        // Listeners para os bot√µes da modal de confirma√ß√£o
        confirmDeleteButton.addEventListener('click', () => deleteKeyConfirmed(keyToDeleteId)); // Passa o ID armazenado
        cancelDeleteButton.addEventListener('click', hideConfirmationModal);
    </script>
</body>
</html>
